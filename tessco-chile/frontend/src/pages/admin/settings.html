<!DOCTYPE html>
<html lang="es">

<head>
  <title>Configuración - Tessco Chile</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="format-detection" content="telephone=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="author" content="Tessco Chile">
  <meta name="keywords" content="admin,configuración,settings,tessco chile">
  <meta name="description" content="Configuración del sistema - Panel de administración Tessco Chile">
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="../../assets/css/custom-bootstrap.css">
  <link rel="stylesheet" type="text/css" href="../../assets/css/vendor.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css" />
  <link rel="stylesheet" type="text/css" href="../../assets/css/style.css">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome para iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Estilos específicos para admin -->
  <style>
    body {
      background-color: #1a1a1a !important;
      color: #ffffff !important;
    }
    
    .card {
      background-color: #2d2d2d !important;
      border: 1px solid #404040 !important;
    }
    
    .form-control, .form-select {
      background-color: #1a1a1a !important;
      border: 1px solid #404040 !important;
      color: #ffffff !important;
    }
    
    .form-control:focus, .form-select:focus {
      background-color: #1a1a1a !important;
      border-color: #FF6B35 !important;
      color: #ffffff !important;
      box-shadow: 0 0 0 0.2rem rgba(255, 107, 53, 0.25) !important;
    }
    
    .form-label {
      color: #ffffff !important;
    }
    
    .btn-primary {
      background-color: #FF6B35 !important;
      border-color: #FF6B35 !important;
    }
    
    .btn-primary:hover {
      background-color: #E55A2B !important;
      border-color: #E55A2B !important;
    }
    
    .alert {
      border: none !important;
    }
  </style>
</head>

<body data-bs-theme="dark">
  <div id="header"></div>

  <!-- Admin Content -->
  <section class="py-5" style="margin-top: 120px;">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center gap-3">
              <a href="/admin" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Volver
              </a>
              <h1 class="text-white mb-0">
                <i class="fas fa-cog me-2"></i>Configuración del Sistema
              </h1>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Form -->
      <div class="row">
        <div class="col-lg-8">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title text-white mb-4">
                <i class="fas fa-truck me-2"></i>Configuración de Envíos
              </h5>
              
              <div id="alert-container"></div>
              
              <form id="settingsForm">
                <div class="mb-4">
                  <label for="shippingCost" class="form-label">
                    <i class="fas fa-dollar-sign me-2"></i>Precio de Envío a Domicilio (CLP)
                  </label>
                  <input 
                    type="number" 
                    class="form-control" 
                    id="shippingCost" 
                    name="shippingCost" 
                    min="0" 
                    step="100"
                    required
                    placeholder="5000"
                  >
                  <small class="text-muted">
                    Este es el precio que se cobrará por el envío a domicilio cuando el usuario realice una compra.
                  </small>
                </div>
                
                <div class="mb-4">
                  <label for="freeShippingThreshold" class="form-label">
                    <i class="fas fa-gift me-2"></i>Umbral para Envío Gratis (CLP)
                  </label>
                  <input 
                    type="number" 
                    class="form-control" 
                    id="freeShippingThreshold" 
                    name="freeShippingThreshold" 
                    min="0" 
                    step="1000"
                    required
                    placeholder="50000"
                  >
                  <small class="text-muted">
                    Si el total de la compra supera este monto, el envío será gratis.
                  </small>
                </div>
                
                <div class="d-flex justify-content-end gap-2">
                  <button type="button" class="btn btn-secondary" onclick="loadSettings()">
                    <i class="fas fa-undo me-2"></i>Cancelar
                  </button>
                  <button type="submit" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save me-2"></i>Guardar Configuración
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
        
        <div class="col-lg-4">
          <div class="card">
            <div class="card-body">
              <h6 class="card-title text-white mb-3">
                <i class="fas fa-info-circle me-2"></i>Información
              </h6>
              <p class="text-muted small">
                Los cambios en la configuración de envíos se aplicarán inmediatamente a todas las nuevas compras.
              </p>
              <p class="text-muted small">
                Las compras ya realizadas mantendrán el precio de envío que tenían al momento de la compra.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <div id="footer"></div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../../config/env.js"></script>
  <script src="../../config/app.js"></script>
  <script src="../../components/header.js"></script>
  <script src="../../components/footer.js"></script>
  
  <script>
    const API_BASE_URL = (window.config && window.config.apiBaseUrl) || 'http://localhost:4000';
    
    // Verificar autenticación
    function checkAuth() {
      const token = localStorage.getItem('authToken');
      if (!token) {
        window.location.href = '/admin/login';
        return false;
      }
      return true;
    }
    
    // Mostrar alerta
    function showAlert(message, type = 'success') {
      const alertContainer = document.getElementById('alert-container');
      const alertId = 'alert-' + Date.now();
      alertContainer.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert" id="${alertId}">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `;
      
      // Auto-dismiss después de 5 segundos
      setTimeout(() => {
        const alert = document.getElementById(alertId);
        if (alert) {
          const bsAlert = new bootstrap.Alert(alert);
          bsAlert.close();
        }
      }, 5000);
    }
    
    // Cargar configuración
    async function loadSettings() {
      try {
        const token = localStorage.getItem('authToken');
        const response = await fetch(`${API_BASE_URL}/api/settings`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('Error al cargar la configuración');
        }
        
        const data = await response.json();
        const settings = data.data || {};
        
        // Cargar valores o usar defaults
        document.getElementById('shippingCost').value = settings.shippingCost || '5000';
        document.getElementById('freeShippingThreshold').value = settings.freeShippingThreshold || '50000';
        
      } catch (error) {
        console.error('Error cargando configuración:', error);
        // Usar valores por defecto si hay error
        document.getElementById('shippingCost').value = '5000';
        document.getElementById('freeShippingThreshold').value = '50000';
      }
    }
    
    // Guardar configuración
    async function saveSettings(formData) {
      const token = localStorage.getItem('authToken');
      const saveBtn = document.getElementById('saveBtn');
      const originalContent = saveBtn.innerHTML;
      
      // Mostrar loading
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
      
      try {
        // Guardar precio de envío
        const shippingResponse = await fetch(`${API_BASE_URL}/api/settings/shippingCost`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ value: formData.shippingCost })
        });
        
        if (!shippingResponse.ok) {
          throw new Error('Error al guardar el precio de envío');
        }
        
        // Guardar umbral de envío gratis
        const thresholdResponse = await fetch(`${API_BASE_URL}/api/settings/freeShippingThreshold`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ value: formData.freeShippingThreshold })
        });
        
        if (!thresholdResponse.ok) {
          throw new Error('Error al guardar el umbral de envío gratis');
        }
        
        showAlert('Configuración guardada exitosamente', 'success');
        
      } catch (error) {
        console.error('Error guardando configuración:', error);
        showAlert('Error al guardar la configuración: ' + error.message, 'danger');
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalContent;
      }
    }
    
    // Manejar envío del formulario
    document.getElementById('settingsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = {
        shippingCost: document.getElementById('shippingCost').value,
        freeShippingThreshold: document.getElementById('freeShippingThreshold').value
      };
      
      await saveSettings(formData);
    });
    
    // Inicializar
    document.addEventListener('DOMContentLoaded', () => {
      if (checkAuth()) {
        loadSettings();
      }
    });
  </script>
</body>
</html>

